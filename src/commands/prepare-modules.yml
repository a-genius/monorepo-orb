description: >
  Creates a new continuation config by merging multiple configs listed in << modules-path >> file into one.
  If << default-modules >> parameter is set, files specified will always be merged.

parameters:
  modules-path:
    description: Path to the file for the list of the modules to build
    type: string
    default: /tmp/modules.txt
  default-modules:
    description: >
      A comma-separated list of default modules to join.
      Each module must have `.circleci/config.yml` in it.
    type: string
    default: ""

steps:
  - run:
      name: Prepare modules for merging
      shell: /usr/bin/env python3
      environment:
        MODULES_PATH: << parameters.modules-path >>
        DEFAULT_MODULES: << parameters.default-modules >>
      command: << include(scripts/prepare_modules.py) >>
  - run:
      name: Show modules
      command: cat << parameters.modules-path >>
